<!DOCTYPE html>
<html>
<head>
    <title>Vehicle Report Tester - Detection & Matching System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .form-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .form-section h2 {
            color: #333;
            margin-bottom: 20px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            color: #555;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group input,
        .form-group select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .submit-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .results-section {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .results-section.show {
            display: block;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
        }

        .results-header h2 {
            color: #333;
            margin: 0;
        }

        .status-badge {
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.2s;
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }

        .metric-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 28px;
            font-weight: 700;
            color: #333;
        }

        .metric-value.high {
            color: #28a745;
        }

        .metric-value.medium {
            color: #ffc107;
        }

        .metric-value.low {
            color: #dc3545;
        }

        .images-comparison {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .image-card {
            background: #f8f9fa;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .image-card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            font-weight: 600;
            text-align: center;
        }

        .image-card-body {
            padding: 15px;
        }

        .image-card img {
            width: 100%;
            height: auto;
            border-radius: 8px;
            display: block;
        }

        .matches-section {
            margin-top: 30px;
        }

        .matches-section h3 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .match-list {
            display: grid;
            gap: 15px;
        }

        .match-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            transition: all 0.3s;
        }

        .match-item:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transform: translateX(5px);
        }

        .match-item.best {
            border-left-color: #28a745;
            background: linear-gradient(90deg, #d4edda 0%, #f8f9fa 100%);
        }

        .match-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .match-camera {
            font-weight: 700;
            font-size: 18px;
            color: #333;
        }

        .match-similarity {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
        }

        .match-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            font-size: 13px;
            color: #666;
        }

        .match-detail {
            display: flex;
            flex-direction: column;
        }

        .match-detail-label {
            font-weight: 600;
            color: #888;
            font-size: 11px;
            text-transform: uppercase;
        }

        .match-detail-value {
            color: #333;
            font-weight: 500;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 18px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #dc3545;
            margin-top: 20px;
        }

        .preview-image {
            max-width: 300px;
            margin-top: 10px;
            border-radius: 8px;
            display: none;
        }

        .preview-image.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöó Vehicle Tracing & Alert System</h1>
            <p>Advanced Detection & Matching using YOLOv8 + TorchReID + FAISS</p>
        </div>

        <div class="form-section">
            <h2>üì§ Submit Vehicle Report</h2>
            <form id="reportForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Vehicle Image *</label>
                        <input type="file" id="imageInput" accept="image/*" required>
                        <img id="previewImage" class="preview-image" alt="Preview">
                    </div>

                    <div class="form-group">
                        <label>Latitude</label>
                        <input type="number" id="lat" value="21.229001" step="0.000001" required>
                    </div>

                    <div class="form-group">
                        <label>Longitude</label>
                        <input type="number" id="lon" value="81.678221" step="0.000001" required>
                    </div>

                    <div class="form-group">
                        <label>Direction (Optional)</label>
                        <select id="direction">
                            <option value="">-- Skip Direction Filter --</option>
                            <option>north</option>
                            <option>north-east</option>
                            <option>east</option>
                            <option>south-east</option>
                            <option>south</option>
                            <option>south-west</option>
                            <option>west</option>
                            <option>north-west</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Severity (1-5)</label>
                        <input type="number" id="severity" min="1" max="5" value="3" required>
                    </div>
                </div>

                <button type="submit" class="submit-btn" id="submitBtn">
                    üîç Analyze & Match Vehicle
                </button>
            </form>
        </div>

        <div id="loadingSection" class="results-section">
            <div class="loading">
                <div class="spinner"></div>
                <p>Processing vehicle detection and matching...</p>
            </div>
        </div>

        <div id="resultsSection" class="results-section">
            <!-- Results will be dynamically inserted here -->
        </div>
    </div>

    <script>
        // Image preview
        document.getElementById("imageInput").addEventListener("change", function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById("previewImage");
                    preview.src = e.target.result;
                    preview.classList.add("show");
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById("reportForm").addEventListener("submit", async function(e) {
            e.preventDefault();

            const imgFile = document.getElementById("imageInput").files[0];
            if (!imgFile) {
                alert("Please select an image");
                return;
            }

            // Show loading
            document.getElementById("loadingSection").classList.add("show");
            document.getElementById("resultsSection").classList.remove("show");
            document.getElementById("submitBtn").disabled = true;

            let formData = new FormData();
            formData.append("image", imgFile);
            formData.append("latitude", document.getElementById("lat").value);
            formData.append("longitude", document.getElementById("lon").value);

            // Only append direction if it's selected
            const direction = document.getElementById("direction").value;
            if (direction) {
                formData.append("direction", direction);
            }

            formData.append("severity", document.getElementById("severity").value);

            const timestamp = new Date().toISOString();
            formData.append("timestamp", timestamp);

            try {
                const response = await fetch("http://127.0.0.1:8000/report-vehicle", {
                    method: "POST",
                    body: formData
                });

                const data = await response.json();
                console.log("Backend Response:", data);

                // Hide loading
                document.getElementById("loadingSection").classList.remove("show");
                document.getElementById("submitBtn").disabled = false;

                displayResults(data);

            } catch (error) {
                console.error("Error calling backend:", error);
                document.getElementById("loadingSection").classList.remove("show");
                document.getElementById("submitBtn").disabled = false;

                const resultsSection = document.getElementById("resultsSection");
                resultsSection.innerHTML = `
                    <div class="error-message">
                        <h3>‚ùå Connection Error</h3>
                        <p>Failed to connect to backend server. Please ensure the server is running on http://127.0.0.1:8000</p>
                        <p><strong>Error:</strong> ${error.message}</p>
                    </div>
                `;
                resultsSection.classList.add("show");
            }
        });

        function displayResults(data) {
            const resultsSection = document.getElementById("resultsSection");

            if (!data || !data.result) {
                resultsSection.innerHTML = `
                    <div class="error-message">
                        <h3>‚ùå Invalid Response</h3>
                        <p>No result data received from backend</p>
                    </div>
                `;
                resultsSection.classList.add("show");
                return;
            }

            const result = data.result;

            // Check for errors
            if (result.error) {
                let errorMsg = "";
                if (result.error === "no_vehicle_detected") {
                    errorMsg = "No vehicle detected in the uploaded image. Please upload an image containing a vehicle.";
                } else if (result.error === "no_cameras_in_area") {
                    errorMsg = "Vehicle detected but no cameras found in the specified area matching the direction and GPS criteria.";
                } else {
                    errorMsg = result.error;
                }

                resultsSection.innerHTML = `
                    <div class="results-header">
                        <h2>‚ö†Ô∏è Detection Results</h2>
                        <span class="status-badge status-warning">Partial Success</span>
                    </div>
                    <div class="error-message">
                        <h3>‚ö†Ô∏è ${result.error === "no_vehicle_detected" ? "No Vehicle Detected" : "No Cameras Found"}</h3>
                        <p>${errorMsg}</p>
                    </div>
                    ${result.detection_confidence ? `
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <div class="metric-label">Detection Confidence</div>
                                <div class="metric-value ${getConfidenceClass(result.detection_confidence)}">
                                    ${(result.detection_confidence * 100).toFixed(1)}%
                                </div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Vehicles Detected</div>
                                <div class="metric-value">${result.detection_count || 0}</div>
                            </div>
                        </div>
                    ` : ''}
                    ${result.detected_vehicle_image || result.original_image ? `
                        <div class="images-comparison">
                            ${result.original_image_with_bbox ? `
                                <div class="image-card">
                                    <div class="image-card-header">üì∏ Original Image with Detection</div>
                                    <div class="image-card-body">
                                        <img src="${result.original_image_with_bbox}" alt="Original with bbox">
                                    </div>
                                </div>
                            ` : ''}
                            ${result.detected_vehicle_image ? `
                                <div class="image-card">
                                    <div class="image-card-header">üöó Detected Vehicle Crop</div>
                                    <div class="image-card-body">
                                        <img src="${result.detected_vehicle_image}" alt="Detected vehicle">
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                `;
                resultsSection.classList.add("show");
                return;
            }

            // Success case
            const similarity = result.best_similarity || 0;
            const confidence = result.detection_confidence || 0;

            let html = `
                <div class="results-header">
                    <h2>‚úÖ Detection & Matching Results</h2>
                    <span class="status-badge status-success">Match Found</span>
                </div>

                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-label">Detection Confidence</div>
                        <div class="metric-value ${getConfidenceClass(confidence)}">
                            ${(confidence * 100).toFixed(1)}%
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Best Match Similarity</div>
                        <div class="metric-value ${getConfidenceClass(similarity)}">
                            ${(similarity * 100).toFixed(1)}%
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Vehicles Detected</div>
                        <div class="metric-value">${result.detection_count || 0}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Matched Camera</div>
                        <div class="metric-value" style="font-size: 20px;">${result.best_camera || 'N/A'}</div>
                    </div>
                </div>

                <!-- Per-detection side-by-side comparisons -->
                <div class="images-comparison">
                    ${result.original_image_with_bbox ? `
                        <div class="image-card">
                            <div class="image-card-header">üì∏ Uploaded Image with Detection</div>
                            <div class="image-card-body">
                                <img src="${result.original_image_with_bbox}" alt="Original with bbox">
                            </div>
                        </div>
                    ` : ''}

                    <!-- Show each detected crop and (if available) its best camera match side-by-side -->
                    <div style="width:100%;">
                        ${(result.detections && result.detections.length > 0) ? result.detections.map((det, di) => {
                            // For each detection, pick best match if any and try to find the enriched match (with images) from result.matches
                            const bestForDet = (det.matches && det.matches.length > 0) ? det.matches[0] : null;
                            const bestForDetCam = (bestForDet && result.matches && result.matches.length > 0) ? (result.matches.find(m => m.camera_id === bestForDet.camera_id) || bestForDet) : bestForDet;
                            const uploadedCrop = result.detected_vehicles && result.detected_vehicles[di] ? result.detected_vehicles[di] : null;

                            // resolve camera image src (prefer precomputed camera_vehicle_image, then full image)
                            const camImgSrc = bestForDetCam ? (bestForDetCam.camera_vehicle_image || bestForDetCam.camera_full_image || (bestForDetCam.meta && bestForDetCam.meta.image_path)) : null;

                            return `
                                <div class="image-card" style="display:flex; gap:12px; margin-bottom:12px; align-items:center;">
                                    <div style="flex:1;">
                                        <div class="image-card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff;">üöó Uploaded Crop ${di+1}</div>
                                        <div class="image-card-body">
                                            ${uploadedCrop ? `<img src="${uploadedCrop}" alt="Uploaded crop ${di+1}">` : `<div style='padding:20px;color:#666'>No crop available</div>`}
                                        </div>
                                    </div>

                                    <div style="flex:1;">
                                        <div class="image-card-header" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: #fff;">üìπ Best Camera Match</div>
                                        <div class="image-card-body">
                                            ${camImgSrc ? `<img src="${camImgSrc}" alt="Camera match ${di+1}">` : `<div style='padding:20px;color:#666'>No camera match in candidates</div>`}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('') : `<div class='image-card'><div class='image-card-body'>No individual detections to show.</div></div>`}
                    </div>
                </div>
            `;

            // Show uploaded image alongside top-5 camera matches
            if (result.matches && result.matches.length > 0) {
                const top5 = result.matches.slice(0, 5);
                html += `
                    <div style="margin-top:18px; margin-bottom:18px;">
                        <h3 style="margin-bottom:10px; color:#333;">üîé Uploaded Image vs Top ${top5.length} Camera Matches</h3>
                        <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-start;">
                            <div style="flex: 0 0 320px;">
                                <div class="image-card">
                                    <div class="image-card-header">üì∏ Uploaded (Primary Crop)</div>
                                    <div class="image-card-body">
                                        <img src="${(result.detected_vehicles && result.detected_vehicles[0]) || result.detected_vehicle_image || result.original_image}" alt="Uploaded primary">
                                    </div>
                                </div>
                            </div>
                            <div style="flex:1; display:flex; gap:12px; flex-wrap:wrap;">
                                ${top5.map((m, mi) => {
                                    const src = m.camera_vehicle_image || m.camera_full_image || (m.meta && m.meta.image_path) || '';
                                    return `
                                        <div style="width:180px;">
                                            <div class="image-card">
                                                <div class="image-card-header" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">üìπ Match ${mi+1} ‚Äî ${m.camera_id || ''}</div>
                                                <div class="image-card-body">
                                                    ${src ? `<img src="${src}" alt="Match ${mi+1}">` : `<div style='padding:16px;color:#666'>No image</div>`}
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }

            // Add matches section
            if (result.matches && result.matches.length > 0) {
                html += `
                    <div class="matches-section">
                        <h3>üéØ Camera Matches (Top ${result.matches.length})</h3>
                        <div class="match-list">
                `;

                result.matches.forEach((match, index) => {
                    const isBest = index === 0;
                    const matchSimilarity = match.similarity || (1.0 / (1.0 + match.distance));

                    html += `
                        <div class="match-item ${isBest ? 'best' : ''}">
                            <div class="match-header">
                                <div class="match-camera">
                                    ${isBest ? 'üèÜ ' : ''}Camera: ${match.camera_id || 'Unknown'}
                                </div>
                                <div class="match-similarity ${getConfidenceClass(matchSimilarity)}">
                                    ${(matchSimilarity * 100).toFixed(1)}%
                                </div>
                            </div>

                            ${match.camera_vehicle_image || match.camera_full_image ? `
                                <div class="images-comparison" style="margin: 15px 0; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                                    ${match.camera_vehicle_image ? `
                                        <div class="image-card">
                                            <div class="image-card-header" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                                                üìπ Camera Feed Vehicle
                                            </div>
                                            <div class="image-card-body">
                                                <img src="${match.camera_vehicle_image}" alt="Camera vehicle">
                                            </div>
                                        </div>
                                    ` : ''}
                                    ${result.detected_vehicle_image ? `
                                        <div class="image-card">
                                            <div class="image-card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                                üöó Your Uploaded Vehicle
                                            </div>
                                            <div class="image-card-body">
                                                <img src="${result.detected_vehicle_image}" alt="Uploaded vehicle">
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}

                            <div class="match-details">
                                <div class="match-detail">
                                    <span class="match-detail-label">Distance Score</span>
                                    <span class="match-detail-value">${match.distance.toFixed(4)}</span>
                                </div>
                                ${match.meta && match.meta.gps ? `
                                    <div class="match-detail">
                                        <span class="match-detail-label">GPS Location</span>
                                        <span class="match-detail-value">${match.meta.gps[0].toFixed(6)}, ${match.meta.gps[1].toFixed(6)}</span>
                                    </div>
                                ` : ''}
                                ${match.meta && match.meta.direction ? `
                                    <div class="match-detail">
                                        <span class="match-detail-label">Direction</span>
                                        <span class="match-detail-value">${match.meta.direction}</span>
                                    </div>
                                ` : ''}
                                ${match.meta && match.meta.intersection ? `
                                    <div class="match-detail">
                                        <span class="match-detail-label">Intersection</span>
                                        <span class="match-detail-value">${match.meta.intersection}</span>
                                    </div>
                                ` : ''}
                                ${match.meta && match.meta.image_path ? `
                                    <div class="match-detail">
                                        <span class="match-detail-label">Camera Image</span>
                                        <span class="match-detail-value">${match.meta.image_path}</span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            }

            resultsSection.innerHTML = html;
            resultsSection.classList.add("show");
        }

        function getConfidenceClass(value) {
            if (value >= 0.7) return 'high';
            if (value >= 0.4) return 'medium';
            return 'low';
        }
    </script>
</body>
</html>
